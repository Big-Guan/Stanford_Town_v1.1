# 数据库重置操作指南

## 📋 目录

- [功能介绍](#功能介绍)
- [使用场景](#使用场景)
- [使用方法](#使用方法)
- [重置模式说明](#重置模式说明)
- [安全注意事项](#安全注意事项)
- [常见问题](#常见问题)
- [操作示例](#操作示例)

---

## 功能介绍

数据库重置工具用于清空游戏数据，为新一批玩家准备干净的游戏环境。支持两种重置模式：

1. **完全重置**：清空所有数据（用户账号、进度、任务记录）
2. **进度重置**：保留用户账号，只重置游戏进度

---

## 使用场景

### 何时使用完全重置？

- ✅ 新一批玩家开始游戏
- ✅ 测试环境需要清理数据
- ✅ 游戏版本更新，需要重新开始
- ✅ 数据出现严重问题，需要完全重建

### 何时使用进度重置？

- ✅ 同一批玩家重新开始游戏
- ✅ 保留用户账号，只重置积分和关卡
- ✅ 游戏活动结束，准备下一轮

---

## 使用方法

### 方式一：直接运行脚本

```bash
# 进入后端目录
cd backend

# 完全重置（清空所有数据）
node db-reset.js

# 只重置进度（保留用户账号）
node db-reset.js --progress

# 强制模式（跳过确认，慎用！）
node db-reset.js --force
```

### 方式二：使用 npm 脚本（推荐）

```bash
cd backend

# 完全重置
npm run db:reset

# 只重置进度
npm run db:reset:progress

# 强制重置（跳过确认）
npm run db:reset:force
```

---

## 重置模式说明

### 完全重置模式

**清空内容：**
- ❌ 所有用户账号 (`users` 表)
- ❌ 所有用户进度 (`user_progress` 表)
- ❌ 所有任务记录 (`task_completions` 表)

**保留内容：**
- ✅ 数据库表结构
- ✅ 索引和约束
- ✅ 触发器

**适用场景：** 新一批玩家开始游戏

---

### 进度重置模式

**清空内容：**
- ❌ 所有任务记录 (`task_completions` 表)
- ❌ 用户积分（重置为 0）
- ❌ 用户背包（清空）
- ❌ 已完成 NPC 列表（清空）
- ❌ 关卡进度（重置为第 1 关）
- ❌ 玩家位置（重置为初始位置）

**保留内容：**
- ✅ 用户账号 (`users` 表)
- ✅ 用户头像
- ✅ 用户创建时间

**适用场景：** 同一批玩家重新开始游戏

---

## 安全注意事项

### ⚠️ 重要警告

1. **数据不可恢复**：重置操作会永久删除数据，无法恢复！
2. **生产环境慎用**：在生产环境执行前，请先备份数据库
3. **确认机制**：默认需要输入 "RESET" 确认，防止误操作
4. **权限控制**：建议只有管理员可以执行此操作

### 🔒 安全建议

1. **备份数据库**
   ```bash
   # 在执行重置前，建议先备份数据库
   pg_dump -h your_host -U your_user -d ai_stanford_town_v1 > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **测试环境验证**
   - 先在测试环境验证重置脚本
   - 确认无误后再在生产环境执行

3. **通知玩家**
   - 重置前通知所有玩家
   - 告知重置时间和原因

---

## 常见问题

### Q1: 重置后数据能恢复吗？

**A:** 不能。重置操作会永久删除数据。建议在执行前先备份数据库。

### Q2: 重置会影响表结构吗？

**A:** 不会。重置只删除数据，不会修改表结构、索引或约束。

### Q3: 可以只重置某个用户的数据吗？

**A:** 当前脚本不支持。如需重置单个用户，请直接使用 SQL：
```sql
DELETE FROM task_completions WHERE user_id = 'user_id_here';
UPDATE user_progress SET score = 0, inventory = '[]'::jsonb, completed_npcs = '[]'::jsonb, level_index = 0 WHERE user_id = 'user_id_here';
```

### Q4: 重置需要多长时间？

**A:** 取决于数据量。通常：
- 1000 条记录：< 1 秒
- 10000 条记录：1-3 秒
- 100000 条记录：5-10 秒

### Q5: 重置过程中可以继续游戏吗？

**A:** 不建议。重置过程中数据库会被锁定，可能影响正在游戏的玩家。建议在维护时间窗口执行。

### Q6: 如何确认重置成功？

**A:** 重置完成后会显示统计信息。也可以运行健康检查脚本：
```bash
npm run db:health
```

---

## 操作示例

### 示例 1：完全重置（新一批玩家）

```bash
$ cd backend
$ npm run db:reset

═══════════════════════════════════════════════════════
       AI进化小镇 数据库重置工具
═══════════════════════════════════════════════════════

✅ 数据库连接成功: bigguan-v1.rwlb.rds.aliyuncs.com/ai_stanford_town_v1

📋 重置模式: 完全重置（清空所有）

📊 当前数据统计:
   - 用户数: 25
   - 进度记录: 25
   - 任务记录: 156

⚠️  确认要清空所有游戏数据吗？ 输入 "RESET" 确认: RESET

🔄 正在执行完全重置...
   ✅ 任务记录已清空 (删除 156 条)
   ✅ 用户进度已清空 (删除 25 条)
   ✅ 用户数据已清空 (删除 25 条)

═══════════════════════════════════════════════════════
                     重置完成报告
═══════════════════════════════════════════════════════
   📝 任务记录: 删除 156 条
   📈 进度记录: 删除 25 条
   👤 用户账号: 删除 25 条
═══════════════════════════════════════════════════════

✅ 数据库重置完成！新一批玩家可以开始游戏了。
```

---

### 示例 2：进度重置（保留用户）

```bash
$ npm run db:reset:progress

═══════════════════════════════════════════════════════
       AI进化小镇 数据库重置工具
═══════════════════════════════════════════════════════

✅ 数据库连接成功: bigguan-v1.rwlb.rds.aliyuncs.com/ai_stanford_town_v1

📋 重置模式: 进度重置（保留用户）

📊 当前数据统计:
   - 用户数: 25
   - 进度记录: 25
   - 任务记录: 156

⚠️  确认要重置所有玩家的游戏进度吗？（用户账号将保留） 输入 "RESET" 确认: RESET

🔄 正在重置游戏进度（保留用户账号）...
   ✅ 任务记录已清空 (删除 156 条)
   ✅ 用户进度已重置 (更新 25 条)

═══════════════════════════════════════════════════════
                     重置完成报告
═══════════════════════════════════════════════════════
   📝 任务记录: 删除 156 条
   📈 进度记录: 重置 25 条
═══════════════════════════════════════════════════════

✅ 数据库重置完成！新一批玩家可以开始游戏了。
```

---

### 示例 3：取消操作

```bash
$ npm run db:reset

⚠️  确认要清空所有游戏数据吗？ 输入 "RESET" 确认: cancel

❌ 操作已取消
```

---

## 相关命令

### 数据库健康检查

```bash
# 检查数据库状态和结构
npm run db:health
```

### 数据库迁移

```bash
# 执行数据库迁移（添加新字段等）
node run-migration-v3-simple.js
```

### 数据库初始化

```bash
# 初始化数据库表结构（首次部署）
npm run init:db
```

---

## 故障排查

### 问题：连接数据库失败

**解决方案：**
1. 检查 `backend/.env` 文件中的数据库配置
2. 确认数据库服务是否运行
3. 检查网络连接和防火墙设置

### 问题：权限不足

**解决方案：**
1. 确认数据库用户有 DELETE 和 UPDATE 权限
2. 检查外键约束是否允许删除

### 问题：重置后数据还在

**解决方案：**
1. 检查是否有事务未提交
2. 确认执行的是正确的重置模式
3. 查看脚本输出的统计信息

---

## 联系支持

如遇到问题，请：
1. 查看本文档的常见问题部分
2. 检查数据库日志
3. 联系系统管理员

---

**最后更新：** 2025-11-28  
**版本：** v2.0

